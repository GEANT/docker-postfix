#!/usr/bin/env bash
# shellcheck shell=bash

RECIPIENT_ACCESS_HASH_FILE="/etc/postfix/recipient_access.hash"
RECIPIENT_ACCESS_HASH_FILE_LOCAL="/etc/postfix/tables/recipient_access.hash"

# Remove existing client_access.cidr
rm "${RECIPIENT_ACCESS_HASH_FILE}" > /dev/null 2>&1
touch "${RECIPIENT_ACCESS_HASH_FILE}"

# Import local entries into client_access.cidr
if [ -f "${RECIPIENT_ACCESS_HASH_FILE_LOCAL}" ]; then
  echo "" >> "${RECIPIENT_ACCESS_HASH_FILE}"
  echo "## Entries from ${RECIPIENT_ACCESS_HASH_FILE_LOCAL}" >> "${RECIPIENT_ACCESS_HASH_FILE}"
  cat "${RECIPIENT_ACCESS_HASH_FILE_LOCAL}" >> "${RECIPIENT_ACCESS_HASH_FILE}"
  echo "" >> "${RECIPIENT_ACCESS_HASH_FILE}"
fi

# Don't need to run postmap over texthash files
postmap "${RECIPIENT_ACCESS_HASH_FILE}"

# If postfix is running, update
postfix status > /dev/null 2>&1
if [ "$?" -eq "0" ]; then
  postfix reload
fi
