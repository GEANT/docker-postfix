#!/usr/bin/with-contenv bash
# shellcheck shell=bash

set -eo pipefail

if [ "${ENABLE_POSTGREY}" = "true" ]; then
    bash /wait_for_postgrey.sh | awk -W Interactive '{print "[startup] " $0}'
fi

# Wait for clamd, opendkim, clamav-milter
s6-svwait -U /run/s6/services/clamd /run/s6/services/opendkim /run/s6/services/clamav-milter

s6-notifyoncheck \
        -s 1000 \
        -t 1000 \
        -n 0 \
        -c "fdmove 1 3 postfix status" \
        /usr/sbin/postfix start-fg \
        2>&1 | awk -W Interactive '{print "[postfix] " $0}'
